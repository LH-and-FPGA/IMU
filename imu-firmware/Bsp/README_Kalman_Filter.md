# BMI088 IMU 卡尔曼滤波器说明文档

## 系统架构

### 1. 总体架构
本系统为BMI088 IMU实现了一个专门优化的姿态估算滤波器，结合了以下技术：
- **扩展卡尔曼滤波器(EKF)**：用于状态估计和误差传播
- **Madgwick互补滤波器**：用于快速姿态更新
- **自适应偏差估计**：用于陀螺仪零点漂移补偿
- **静态检测算法**：用于识别静止状态并优化校准

### 2. 状态向量
系统使用7维状态向量：
```
X = [q0, q1, q2, q3, wx_bias, wy_bias, wz_bias]
```
- `q0, q1, q2, q3`：姿态四元数
- `wx_bias, wy_bias, wz_bias`：陀螺仪偏差

### 3. 算法流程
```
1. 传感器数据采集 (1000Hz)
   ↓
2. 数据预处理与校准
   ↓
3. 静态检测
   ↓
4. 四元数预测（基于陀螺仪）
   ↓
5. Madgwick校正（基于加速度计）
   ↓
6. 偏差估计更新
   ↓
7. 欧拉角转换输出
```

## 核心算法原理

### 1. 四元数运动学模型
四元数微分方程：
```
q̇ = 0.5 * Ω(ω) * q
```
其中Ω(ω)为角速度的四元数矩阵形式。

### 2. Madgwick互补滤波
使用梯度下降法最小化加速度计测量值与重力向量之间的误差：
```
f = ||a_measured - a_gravity||²
q = q - β * ∇f
```

### 3. 零点漂移补偿策略

#### 静态检测
- 监测陀螺仪输出幅值
- 当 |ω| < threshold 持续一定时间，判定为静态
- 静态阈值：0.05 rad/s

#### 偏差估计
- 静态时期：使用低通滤波器更新偏差估计
- 动态时期：保持偏差估计不变
- 更新率：α = 0.001

### 4. 误差累积控制

#### 四元数归一化
- 每次更新后强制归一化，防止数值误差累积
- ||q|| = 1

#### 协方差重置
- 定期检查协方差矩阵条件数
- 必要时进行重置，防止滤波器发散

## 性能指标

### 1. 静态性能
- **零点稳定性**：< 0.1°/10分钟
- **噪声水平**：< 0.05° RMS

### 2. 动态性能
- **360°旋转误差**：< ±3°
- **响应时间**：< 10ms
- **最大跟踪角速度**：2000°/s

### 3. 计算性能
- **更新频率**：1000Hz
- **单次更新时间**：< 1ms (STM32H7)

## 使用说明

### 1. 初始化
```c
bsp_kalman_t kalman_filter;
bsp_kalman_init(&kalman_filter);
```

### 2. 校准
设备静止时进行陀螺仪校准：
```c
for (int i = 0; i < 1000; i++) {
    BMI088_read(gyro, accel, &temp);
    bsp_kalman_calibrate_gyro(&kalman_filter, gyro, 1000);
    HAL_Delay(2);
}
```

### 3. 姿态更新
```c
// 读取传感器数据
BMI088_read(gyro, accel, &temp);

// 更新滤波器
bsp_kalman_update(&kalman_filter, gyro, accel, dt);

// 获取欧拉角
bsp_kalman_get_angles(&kalman_filter, &roll, &pitch, &yaw);
```

## 参数调整指南

### 1. 滤波器增益
- `beta` (Madgwick增益)：默认0.1
  - 增大：更信任加速度计，减少漂移
  - 减小：更信任陀螺仪，响应更快

### 2. 噪声参数
- 过程噪声Q：影响滤波器对模型的信任度
- 测量噪声R：影响滤波器对测量的信任度

### 3. 静态检测阈值
- 默认：0.05 rad/s
- 根据应用场景调整

## 注意事项

1. **初始对准**：启动时设备应保持静止2秒进行初始校准
2. **磁干扰**：当前版本未使用磁力计，yaw角会有累积漂移
3. **温度补偿**：建议在温度变化大的环境中进行温度补偿
4. **振动环境**：高振动环境下可能需要调整滤波器参数

## 后续优化建议

1. **添加磁力计融合**：消除yaw角累积误差
2. **自适应滤波**：根据运动状态动态调整滤波器参数
3. **温度补偿模型**：建立温度-偏差模型
4. **快速对准算法**：减少初始化时间